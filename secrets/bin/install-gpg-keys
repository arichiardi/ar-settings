#!/usr/bin/env bash
set -euo pipefail

temp_dir=$(mktemp -d -t "ar-bootstrap.XXXXXXXXXX")

source ./helpers

gnupg_file_name=gnupg-unstripped-arichiardi.tar.enc
gnupg_backup_url="https://f000.backblazeb2.com/file/secrets-f3ba7cb4/$gnupg_file_name"
gnupg_temp_path="$temp_dir/$gnupg_file_name"
gnupg_unencrypted_path=${gnupg_temp_path%.enc}
gnupg_home=$HOME

echo-info "Download GnuPG backup"
curl -fsSLo $gnupg_temp_path $gnupg_backup_url

echo-info "Decrypt GnuPG backup"
openssl enc -d -aes-256-cbc -pbkdf2 -in $gnupg_temp_path -out $gnupg_unencrypted_path

if [ -d "$gnupg_home/.gnupg" ]; then
    echo-fail "Directory $gnupg_home/.gnupg already exists, aborting."
    exit 64
fi

echo-info "Expand GnuPG backup into $gnupg_home/.gnupg"
tar -xvf $gnupg_unencrypted_path -C $gnupg_home

GNUPGCONFIG=${GNUPGHOME:-"$HOME/.gnupg/gpg-agent.conf"}
echo-info "Enable GnuPG SSH support"

echo 'enable-ssh-support:0:1' | gpgconf --change-options gpg-agent
export SSH_AUTH_SOCK=$(gpgconf --list-dirs agent-ssh-socket)
gpgconf --reload gpg-agent
